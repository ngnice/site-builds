<!-- # 揭秘 Angular 模板微语法 -->

<p>微语法，又称模板微语法，是 Angular 框架中的一种<strong>轻量级语言</strong>，由 Angular 解释和使用。</p>
<p>微语法与 Angular 的<strong>结构型指令</strong>密切相关，它允许我们使用简洁、友好且易读的字符串来快速配置指令。这种微语法机制同样适用于自定义的结构型指令。</p>
<p>在深入讨论微语法之前，我们先来了解一下 Angular 指令（directive）的概念。</p>

        <h2 id="%E6%8C%87%E4%BB%A4" class="docs-header-link">
          <span header-link="%E6%8C%87%E4%BB%A4"></span>
          指令
        </h2>
      <p>在 Angular 中，指令被划分为<strong>三种</strong>，它们分别是：</p>
<ul>
<li>组件型指令：带有模板的指令。这种指令类型是最常见的指令类型。</li>
<li>属性型指令：更改元素、组件或其他指令的外观或行为的指令。</li>
<li>结构型指令：通过添加和删除 DOM 元素来更改 DOM 布局。</li>
</ul>
<blockquote>
<p>你可能会困惑，为什么组件会是指令？事实上，所有组件皆为指令，组件派生自指令。从技术角度上来讲，组件就是一个自带模板的指令。</p>
</blockquote>

        <h2 id="%E7%BB%93%E6%9E%84%E5%9E%8B%E6%8C%87%E4%BB%A4" class="docs-header-link">
          <span header-link="%E7%BB%93%E6%9E%84%E5%9E%8B%E6%8C%87%E4%BB%A4"></span>
          结构型指令
        </h2>
      <p>结构型指令的职责是负责 HTML 布局，它们具有塑造或重塑 DOM 结构的能力，比如添加、移除或维护这些 DOM 元素。</p>
<p>Angular 提供了一组内置的结构指令，例如 <code>NgIf</code>、<code>NgForOf</code>、<code>NgSwitchCase</code>、<code>NgComponentOutlet</code> 等。</p>

        <h2 id="%E6%98%9F%E5%8F%B7%E5%89%8D%E7%BC%80" class="docs-header-link">
          <span header-link="%E6%98%9F%E5%8F%B7%E5%89%8D%E7%BC%80"></span>
          星号前缀
        </h2>
      <p>在使用结构指令时，它们通常以星号 <code>*</code> 为前缀，例如 <code>*ngIf</code>。这种约定是 Angular 提供的一种速记形式，Angular 会将其解释并转换为完整形式的指令属性绑定；具体而言，Angular 会将结构指令前面的星号转换为包围宿主元素及其后代的 <code>&lt;ng-template&gt;</code>，例如：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hero<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ hero.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></div></code></pre>
<p>Angular 会将 <code>*</code> 翻译为 <code>&lt;ng-template&gt;</code>，然后将结构指令的绑定<strong>展开</strong>为完整的属性绑定，并将这些绑定<strong>转移</strong>到 <code>&lt;ng-template&gt;</code> 中去：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span> <span class="token attr-name">[ngIf]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hero<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ hero.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-template</span><span class="token punctuation">></span></span></div></code></pre>
<p>细心的你会发现，当结构型指令的微语法被解析并展开后，它们实际上是属性型指令的一种形式。但与普通属性型指令不同的是，它们是<strong>附加</strong>在 <code>&lt;ng-template&gt;</code> 上的，并且结构指令本身具备<strong>操纵</strong>这个 <code>&lt;ng-template&gt;</code> 的能力。</p>
<blockquote>
<p>所有能够操纵其所<strong>附在</strong>的 <code>&lt;ng-template&gt;</code> 的指令都可以是结构型指令。</p>
</blockquote>

        <h2 id="%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F" class="docs-header-link">
          <span header-link="%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F"></span>
          语法格式
        </h2>
      <p>这是从 Angular 文档上提供的微语法格式参考：</p>
<pre class="language-html"><code class="language-html"><div>*:prefix="( :let | :expression ) (';' | ',')? ( :let | :as | :keyExp )*"</div></code></pre>
<p>看上去十分抽象，令人困惑，让我们来逐步简化它。</p>
<p>我们先删除一些无关紧要的符号（<code>:</code> 与 <code>&#39;</code>），并将 <code>keyExp</code> 改写为全写 <code>keyExpression</code>，然后打开语法高亮：</p>
<div class="dg-paragraph"><img src="assets/images/template/microsyntax-text.png" alt=""></div>
<p>看起来变得更清晰了，但仍然有些复杂。放心，我先来解释一些比较简单的白色符号，以便更好地理解：</p>
<ul>
<li><code>()</code> 表示一对括号为一组；</li>
<li><code>?</code> 表示可选；</li>
<li><code>*</code> 表示可以出现零次或多次。</li>
<li><code>|</code> 表示或（OR）</li>
</ul>
<p>接下来，我们可以去掉这些符号，减少视觉上的混乱；然后采用颜色对这些语法关键字进行分类，使相同类型的关键字具有相同的颜色。</p>
<div class="dg-paragraph"><img src="assets/images/template/microsyntax-group.png" alt=""></div>
<p>让我们更进一步，消除这些文字标注，并改进样式：</p>
<div class="dg-paragraph"><img src="assets/images/template/microsyntax-group-block.png" alt=""></div>
<p>看上去更清晰了！我们先来简单的认识一下这些关键字，稍后我们会更加深入地研究它们：</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>prefix</code></td>
<td>指令输入的前缀</td>
<td></td>
</tr>
<tr>
<td><code>let</code></td>
<td>用于声明模板输入变量</td>
<td><code>let item</code>、<code>let idx=index</code>、...</td>
</tr>
<tr>
<td><code>as</code></td>
<td>与 <code>let</code> 基本相同，但语法不同</td>
<td><code>as item</code>、<code>index as idx</code>、...</td>
</tr>
<tr>
<td><code>expression</code></td>
<td>标准的 Angular 表达式</td>
<td><code>1 &gt; 0</code>、<code>[1, 2]</code>、<code>value | pipe</code>、...</td>
</tr>
<tr>
<td><code>keyExpression</code></td>
<td><code>key</code> + <code>expression</code> 的组合语法</td>
<td>*ngFor=&quot;let item <code>of array</code>&quot;</td>
</tr>
<tr>
<td><code>;</code>、<code>,</code></td>
<td>可选的语句结束符、分隔符</td>
<td></td>
</tr>
</tbody></table>

        <h2 id="%E8%AF%AD%E6%B3%95%E8%A7%A3%E6%9E%90" class="docs-header-link">
          <span header-link="%E8%AF%AD%E6%B3%95%E8%A7%A3%E6%9E%90"></span>
          语法解析
        </h2>
      <p>为了更快地学习，我们以大家熟悉的 <code>NgFor</code> 结构指令为例。在开始之前，我们先来快速查看一下 <code>NgFor</code> 结构指令的基本定义：</p>
<pre class="language-ts"><code class="language-ts"><div><span class="token comment" spellcheck="true">/* 简化版本 */</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">'[ngFor][ngForOf]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">NgForOf</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ngForOf<span class="token punctuation">:</span> T<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ngForTrackBy<span class="token punctuation">:</span> TrackByFunction<span class="token punctuation">;</span>
  template<span class="token punctuation">:</span> TemplateRef<span class="token operator">&lt;</span>NgForOfContext<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></div></code></pre>
<p>我们注意到，实际上 <code>NgFor</code> 结构指令的准确名称为 <code>NgForOf</code>:</p>
<ul>
<li>它的选择器被定义为 <code>[ngFor][ngForOf]</code>，也就是元素上必须<strong>同时</strong>拥有 <code>ngFor</code> 与 <code>ngForOf</code> 两个属性；</li>
<li>它<strong>主要</strong>接收两个指令输入，分别是 <code>ngForOf</code> 和 <code>ngForTrackBy</code>；</li>
<li>它还为它<strong>所在</strong>的 <code>&lt;ng-template&gt;</code> 提供了一个模板上下文，这个上下文的定义是：</li>
</ul>
<pre class="language-ts"><code class="language-ts"><div><span class="token comment" spellcheck="true">/* 简化版本 */</span>
<span class="token keyword">interface</span> <span class="token class-name">NgForOfContext</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
  $implicit<span class="token punctuation">:</span> T<span class="token punctuation">;</span>
  ngForOf<span class="token punctuation">:</span> T<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  index<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  count<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  first<span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>
  last<span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>
  even<span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>
  odd<span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></div></code></pre>
<p>也就是说，<code>NgFor</code> 指令所在的 <code>&lt;ng-template&gt;</code> 上可以接收如下模板输入变量，这些变量均由 <code>NgFor</code> 指令来传递：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span>
  <span class="token attr-name">let-item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>$implicit<span class="token punctuation">"</span></span>
  <span class="token attr-name">let-array</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ngForOf<span class="token punctuation">"</span></span>
  <span class="token attr-name">let-idx</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span>
  <span class="token attr-name">let-length</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span>
  <span class="token attr-name">let-first</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>first<span class="token punctuation">"</span></span>
  <span class="token attr-name">let-last</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>last<span class="token punctuation">"</span></span>
  <span class="token attr-name">let-even</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>even<span class="token punctuation">"</span></span>
  <span class="token attr-name">let-odd</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>odd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-template</span><span class="token punctuation">></span></span></div></code></pre>
<p>让我们忘掉微语法，只根据 <code>NgFor</code> 结构指令的定义，我们需要以这种方式来使用它：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span> <span class="token attr-name">ngFor</span> <span class="token attr-name">[ngForOf]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>heros<span class="token punctuation">"</span></span> <span class="token attr-name">let-hero</span> <span class="token attr-name">let-idx</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>{{ hero.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-template</span><span class="token punctuation">></span></span></div></code></pre>
<p>如果使用微语法，也就是更为常见的写法，它应该是这样的：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngFor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>let hero of heros; let idx<span class="token punctuation">=</span>index<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  {{ hero.name }}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></div></code></pre>
<p>那么 Angular 究竟是如何将微语法翻译为普通写法的呢？让我们只关注微语法部分，并与语法参考规则进行对照：</p>
<div class="dg-paragraph"><img src="assets/images/template/microsyntax-group-block.png" alt="">
<img src="assets/images/template/ngfor-of-let.png" alt=""></div>
<p>我们先来看一下 “<code>*ngFor</code>” 部分：</p>
<ul>
<li>其中 <code>*</code> 便是之前我们介绍的星号前缀，Angular 会将它翻译为一个 <code>&lt;ng-template&gt;</code>。</li>
<li>而 <code>ngFor</code> 则是 <code>NgFor</code> 指令的输入的属性名前缀，也就是 <code>ngForOf</code> 和 <code>ngForTrackBy</code> 的共同前缀。</li>
</ul>

        <h3 id="let%EF%BC%88%E7%BA%A2%E8%89%B2%EF%BC%89" class="docs-header-link">
          <span header-link="let%EF%BC%88%E7%BA%A2%E8%89%B2%EF%BC%89"></span>
          let（红色）
        </h3>
      <p>接着是属性值部分，先来看一下 <code>let</code> 部分，也就是红色部分：</p>
<ul>
<li><code>let hero</code></li>
<li><code>let idx=index</code></li>
</ul>
<div class="dg-paragraph"><code>let</code> 关键字用于声明模板输入变量，我们可以在模板中引用这个变量。在这个例子中，输入变量就是 <code>hero</code> 和 <code>idx</code>，微语法解析器会把<code>let hero</code> 和 <code>let idx</code> 翻译成 <code>&lt;ng-template&gt;</code> 上的模板输入变量：</div>
<table>
<thead>
<tr>
<th>微语法</th>
<th>原始写法</th>
</tr>
</thead>
<tbody><tr>
<td><code>let hero</code></td>
<td><code>&lt;ng-template let-hero=&quot;$implicit&quot;&gt;</code>（与 <code>&lt;ng-template let-hero&gt;</code> 等效）</td>
</tr>
<tr>
<td><code>let idx=index</code></td>
<td><code>&lt;ng-template let-idx=&quot;index&quot;&gt;</code></td>
</tr>
</tbody></table>
<p>我们可以注意到，<code>let hero</code> 被翻译为了 <code>let-hero=&quot;$implicit&quot;</code>，这说明如果不指定 <code>let</code> 的值，则会使用默认值 <code>$implicit</code>。</p>

        <h3 id="keyexpression%EF%BC%88%E7%B4%AB%E8%89%B2%EF%BC%89" class="docs-header-link">
          <span header-link="keyexpression%EF%BC%88%E7%B4%AB%E8%89%B2%EF%BC%89"></span>
          keyExpression（紫色）
        </h3>
      <p>然后是紫色的 <code>of heros</code>，它是 <code>key</code> + <code>expression</code> 的组合语法。</p>
<p>前面已经介绍过，<code>expression</code> 是标准 Angular 表达式，那 <code>key</code> 是什么？我们这样来看一下：</p>
<ul>
<li><code>key expression</code></li>
<li><code>of heros</code></li>
</ul>
<p>显而易见，<code>heros</code> 是 <code>expression</code>，而 <code>of</code> 就是 <code>key</code>。那这个 <code>of</code> 是从哪里来的呢？回想一下前面我们提到的 <code>prefix</code> 前缀。</p>
<p>在这个例子中，前缀为 <code>ngFor</code>，那么 <code>prefix + key = prefixKey</code>，也就是 <code>ngFor + of = ngForOf</code>。而 <code>ngForOf</code> 正是 <code>NgFor</code> 指令的一个输入。</p>
<p>没错，Angular 就是这样来翻译 <code>keyExpression</code> 的。微语法解析器接收 <code>of</code>，把它的首字母大写（of -&gt; Of），并且给它们加上指令的属性名（ngFor）前缀，最终生成的名字是 <code>ngForOf</code>！</p>
<p>理解这部分可能是微语法中最具挑战性的。一旦理解，你就基本掌握了微语法的要领。</p>
<p>让我们再来看一个例子：</p>
<p>有时候在使用 <code>*ngFor</code> 的时候，我们还会传递 <code>trackBy</code> 参数，用于提升列表渲染性能：</p>
<div class="dg-paragraph"><img src="assets/images/template/ngfor-of-trackby.png" alt=""></div>
<p>可以注意到，<code>of hero</code> 和 <code>trackBy: trackFn</code> 都显示为紫色，这表明它们都是 <code>keyExpression</code>。不同的是，<code>trackBy: trackFn</code> 中包含了一个 <code>:</code> 符号。这个冒号是<strong>可选</strong>的，但通常为了提高可读性，我们会选择保留它。</p>
<p>来看看微语法解析器是如何解释它的：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span> <span class="token attr-name">ngFor</span> <span class="token attr-name">let-hero</span> <span class="token attr-name">[ngForOf]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>heros<span class="token punctuation">"</span></span> <span class="token attr-name">[ngForTrackBy]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>trackFn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></div></code></pre>
<p>与 <code>ngForOf</code> 一样，微语法解析器接收 <code>trackBy</code>，把它的首字母大写（trackBy -&gt; TrackBy），并且给它们加上指令的属性名（ngFor）前缀，最终生成的名字是 <code>ngForTrackBy</code>。</p>
<p>并且 <code>keyExpression</code> 之间的顺序是不固定的，这意味着 <code>ngFor</code> 可以有更多写法：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngFor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>let hero; of: heros; trackBy: trackFn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngFor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>let hero; trackBy: trackFn; of: heros<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngFor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>let hero trackBy trackFn of heros<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></div></code></pre>
<p>以上几种写法都是等效的，它们都符合微语法的规则，只是在一些可选符号和书写顺序上有所不同。</p>

        <h3 id="as%EF%BC%88%E8%93%9D%E8%89%B2%EF%BC%89" class="docs-header-link">
          <span header-link="as%EF%BC%88%E8%93%9D%E8%89%B2%EF%BC%89"></span>
          as（蓝色）
        </h3>
      <div class="dg-paragraph"><code>as</code> 语法 与 <code>let</code> 语法在意思上基本相同，但语法稍有不同，我们来看一个例子：</div>
<div class="dg-paragraph"><img src="assets/images/template/ngfor-of-as.png" alt=""></div>
<p>与 <code>let</code> 语法类似，微语法解析器会将 <code>index as idx</code> 翻译为 <code>&lt;ng-template&gt;</code> 上的一个模板输入变量：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span> <span class="token attr-name">ngFor</span> <span class="token attr-name">let-hero</span> <span class="token attr-name">[ngForOf]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>heros<span class="token punctuation">"</span></span> <span class="token attr-name">let-idx</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></div></code></pre>
<p>这很好理解，它的用法与 <code>let</code> 语法基本相同，但它还有一种高级用法。</p>
<p>这次我们使用 <code>NgIf</code> 结构指令来举例。同样的，我们先来看一下 <code>NgIf</code> 结构指令的基本定义：</p>
<pre class="language-ts"><code class="language-ts"><div><span class="token comment" spellcheck="true">/* 简化版本 */</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">'[ngIf]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">NgIf</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ngIf<span class="token punctuation">:</span> T<span class="token punctuation">;</span>
  template<span class="token punctuation">:</span> TemplateRef<span class="token operator">&lt;</span>NgIfContext<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></div></code></pre>
<p>通过 <code>NgIf</code> 指令的定义，我们可以得知：</p>
<ul>
<li>它的选择器被定义为 <code>[ngIf]</code></li>
<li>它<strong>主要</strong>接收一个名为 <code>ngIf</code> 的输入（与选择器同名）。</li>
<li>它还为它<strong>所在</strong>的 <code>&lt;ng-template&gt;</code> 提供了一个模板上下文，这个上下文的定义是：</li>
</ul>
<pre class="language-ts"><code class="language-ts"><div><span class="token comment" spellcheck="true">/* 简化版本 */</span>
<span class="token keyword">interface</span> <span class="token class-name">NgIfContext</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
  $implicit<span class="token punctuation">:</span> T<span class="token punctuation">;</span>
  ngIf<span class="token punctuation">:</span> T<span class="token punctuation">;</span>
<span class="token punctuation">}</span></div></code></pre>
<p>也就是说，<code>NgIf</code> 指令所在的 <code>&lt;ng-template&gt;</code> 上可以接收如下模板输入变量，这些变量均由 <code>NgIf</code> 指令来传递：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span> <span class="token attr-name">let-value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>$implicit<span class="token punctuation">"</span></span> <span class="token attr-name">let-value2</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ngIf<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></div></code></pre>
<div class="dg-paragraph"><code>NgIf</code> 结构指令的用法非常简单，我们直接来查看微语法部分：</div>
<div class="dg-paragraph"><img src="assets/images/template/ngif.png" alt=""></div>
<p>橙色的 <code>1 &gt; 0</code> 是一个 <code>expression</code>，也就是标准 Angular 表达式。</p>
<p>有时候我们在 <code>*ngIf</code> 中使用 <code>async</code> 管道时，通常还会搭配 <code>as</code> 关键字，将管道的输出结果<strong>储存</strong>为一个变量，以便在模板中复用它：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(obs$ | async) as hero<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ hero.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></div></code></pre>
<p>其实有没有管道都可以这样来使用 <code>as</code> 语法。我们把管道拿掉，只关注微语法部分，开启语法高亮：</p>
<div class="dg-paragraph"><img src="assets/images/template/ngif-as.png" alt=""></div>
<p>我们可以发现，<code>hero</code> 与 <code>as alias</code> 是分开的，<code>hero</code> 只是一个 <code>expression</code>，并没有在本质上“将 <code>hero</code> 作为 <code>alias</code>”。尽管如此，在视觉上却呈现出一种“将 <code>hero</code> 作为 <code>alias</code>”的感觉，并且符合直觉。</p>
<p>那么究竟这里是将什么东西来作为 <code>alias</code> 呢？</p>
<p>事实上，这里的 <code>as alias</code> 是应用在 <code>prefix</code> 上的，也就是 <code>ngIf</code>，来看看微语法解析器是如何解释它的：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span> <span class="token attr-name">[ngIf]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hero<span class="token punctuation">"</span></span> <span class="token attr-name">let-alias</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ngIf<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></div></code></pre>
<p>现在我们可以了解到，当 <code>as</code> 前面不是一个模板输入变量时，微语法解析器会自动将 <code>prefix</code> 视作变量名。因此，这里的完整形式应该是这样的：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hero; ngIf as alias<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></div></code></pre>
<p>通过指令定义可以得知，模板上除了有一个与选择器同名的 <code>ngIf</code> 变量，还有一个名为 <code>$implicit</code> 的隐式变量，我们可以使用 <code>let</code> 语法去取到它：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hero; let alias<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></div></code></pre>
<p>我们还可以把 <code>ngIf</code> 前缀缩短为 <code>ng</code>，甚至更短。此时需要这样来使用：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ng</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>let alias1 if hero; let alias2<span class="token punctuation">=</span>ngIf<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></div></code></pre>
<div class="dg-paragraph"><a target="_blank" href="https://stackblitz.com/edit/stackblitz-starters-fvi7go?file=src%2Fmain.ts">查看在线示例</a></div>
<p>看起来与 <code>*ngFor</code> 的书写方式有些相似，但这种写法也是完全符合微语法的语法规则的。根据我们之前学到的知识，要理解它也是比较容易的：</p>
<div class="dg-paragraph"><img src="assets/images/template/ng-if-let.png" alt=""></div>
<p>我们重点关注一下紫色的 <code>if hero</code>，它是一个 <code>keyExpression</code>。微语法解析器接收 <code>if</code>，把它的首字母大写（if -&gt; If），并且给它们加上指令的属性名（ng）前缀，最终生成的名字是 <code>ngIf</code>。</p>
<br>

<blockquote>
<p>🧠 <strong>小测验</strong></p>
<div class="dg-paragraph"><code>ngFor</code> 也能把前缀缩短为 <code>ng</code> 来使用吗？如果可以，微语法应该怎么写？（答案在文末揭晓）</div>
</blockquote>

        <h2 id="%E8%AF%AD%E6%B3%95%E5%AE%9E%E6%88%98" class="docs-header-link">
          <span header-link="%E8%AF%AD%E6%B3%95%E5%AE%9E%E6%88%98"></span>
          语法实战
        </h2>
      <p>通过实践是加深对微语法理解的极佳方式。尝试编写自己的自定义结构型指令，这样可以更直观地体验微语法的作用和用法。通过编写实际的 Angular 模板代码，你可以更深入地理解和熟悉微语法的工作原理和实际应用场景。</p>

        <h3 id="*myvar" class="docs-header-link">
          <span header-link="*myvar"></span>
          *myVar
        </h3>
      <p>让我们创建一个 <code>*myVar</code> 结构指令，用于在模板中直接声明可复用的模板变量，我们期望可以像这样使用它：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*myVar</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123 * 5 as value<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ value }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*myVar</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hero.name; let name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*myVar</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>value | pipe as hero<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ hero.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*myVar</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>value | pipe; let hero<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ hero.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></div></code></pre>
<p>它的写法有些类似于 <code>*ngIf</code>，但是专门用于声明模板局部变量，不会支持条件渲染模板。</p>
<p>我们来简单分析一下这个指令：</p>
<ul>
<li>首先它的选择器需要定义为 <code>[myVar]</code>；</li>
<li>它接收一个与选择器<strong>同名</strong>的 <code>myVar</code> 输入，并且为了能够复用它的值类型，我们还需要定义一个泛型 <code>T</code>；</li>
<li>通过注入 <a target="_blank" href="https://angular.io/api/core/TemplateRef"><code>TemplateRef</code></a> 对象，我们可以得到当前指令<strong>所在</strong>的 <code>&lt;ng-template&gt;</code> 的引用对象；</li>
<li>为了渲染 <code>&lt;ng-template&gt;</code>，我们需要使用 <a target="_blank" href="https://angular.io/api/core/ViewContainerRef"><code>ViewContainerRef</code></a>，通过注入直接得到它；</li>
<li>为了简单起见，我们这里不会去处理指令输入值发生变更的情况。</li>
<li>我们需要支持 <code>as hero</code> 与 <code>let hero</code> 语法：<ul>
<li><code>as hero</code> 全写为 <code>myVar as hero</code>；</li>
<li><code>let hero</code> 全写为 <code>let hero=$implicit</code>
这意味着我们需要提供一个模板上下文：<code>{ myVar, $implicit }</code></li>
</ul>
</li>
<li>不需要处理模板视图销毁的逻辑，因为它会随着指令的销毁而销毁。</li>
</ul>
<blockquote>
<p>为了改善开发体验，我们还会利用静态属性 <code>ngTemplateContextGuard</code> 来声明模板上下文的类型。它不属于当前讨论的主题范围，请自行参考<a target="_blank" href="https://angular.io/guide/structural-directives#making-in-template-type-requirements-more-specific-with-template-guards">相关文档</a>获取更多信息。</p>
</blockquote>
<p>直接来看最终的代码实现：</p>
<pre class="language-ts"><code class="language-ts"><div><span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> OnInit<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> inject<span class="token punctuation">,</span> TemplateRef<span class="token punctuation">,</span> ViewContainerRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">'[myVar]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MyVarDirective</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> template<span class="token punctuation">:</span> TemplateRef<span class="token operator">&lt;</span>MyVarContext<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">></span> <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>TemplateRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> container <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>ViewContainerRef<span class="token punctuation">)</span><span class="token punctuation">;</span>

  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> myVar<span class="token operator">!</span><span class="token punctuation">:</span> T<span class="token punctuation">;</span>

  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建上下文</span>
    <span class="token keyword">const</span> context<span class="token punctuation">:</span> MyVarContext<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      myVar<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>myVar<span class="token punctuation">,</span>
      $implicit<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>myVar
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 渲染模板，并传入上下文</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>template<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 可选的模板类型守卫，帮助模板编译器确定模板上下文类型</span>
  <span class="token keyword">static</span> ngTemplateContextGuard<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>
    dir<span class="token punctuation">:</span> MyVarDirective<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span>
    ctx<span class="token punctuation">:</span> unknown
  <span class="token punctuation">)</span><span class="token punctuation">:</span> ctx is MyVarContext<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/** TemplateRef 上下文接口 */</span>
<span class="token keyword">interface</span> <span class="token class-name">MyVarContext</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
  myVar<span class="token punctuation">:</span> T<span class="token punctuation">;</span>
  $implicit<span class="token punctuation">:</span> T<span class="token punctuation">;</span>
<span class="token punctuation">}</span></div></code></pre>
<div class="dg-paragraph"><a target="_blank" href="https://stackblitz.com/edit/stackblitz-starters-asstkc?file=src%2Fmain.ts">查看在线示例</a>，Enjoy!</div>

        <h3 id="*myinject" class="docs-header-link">
          <span header-link="*myinject"></span>
          *myInject
        </h3>
      <p>我们再来写一个 <code>*myInject</code> 结构指令，用于在模板使用依赖注入（DI）功能。我们希望能够像这样使用它：</p>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">*myInject</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MyService as service<span class="token punctuation">"</span></span> <span class="token attr-name">(click)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>service.action()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  Tap me
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">*myInject</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MyService as service; optional: true<span class="token punctuation">"</span></span> <span class="token attr-name">(click)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>service?.action()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  Tap me
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">*myInject</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MyService as service; host: true; skipSelf: true<span class="token punctuation">"</span></span> <span class="token attr-name">(click)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>service.action()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  Tap me
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></div></code></pre>
<p>我们来简单分析一下这个指令：</p>
<ul>
<li>首先它的选择器需要定义为 <code>[myInject]</code>；</li>
<li>它<strong>主要</strong>接受一个与选择器<strong>同名</strong>的 <code>myInject</code> 输入，以及一系列注入选项输入（<code>host</code>、<code>optional</code> 等）。需要注意的是，为了使用微语法，这些输入的名称都需要有 <code>myInject</code> 前缀。</li>
<li>通过注入 <code>TemplateRef</code> 对象，我们可以得到当前指令所在的 <code>&lt;ng-template&gt;</code> 的引用对象；</li>
<li>为了渲染 <code>&lt;ng-template&gt;</code>，我们需要使用 <code>ViewContainerRef</code>，通过注入直接得到它；</li>
<li>为了简单起见，我们这里不会去处理指令输入值发生变更的情况。</li>
<li>为了支持 <code>as value</code> 语法（全写为 <code>myInject as value</code>），我们的模板上下文需要定义为 <code>{ myInject }</code></li>
</ul>
<p>来看看最终代码实现：</p>
<pre class="language-ts"><code class="language-ts"><div><span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> inject<span class="token punctuation">,</span> Injector<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> OnInit<span class="token punctuation">,</span> ProviderToken<span class="token punctuation">,</span> TemplateRef<span class="token punctuation">,</span> ViewContainerRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">'[myInject]'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MyInjectDirective</span><span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">ProviderToken</span><span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token operator">></span><span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> template <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>TemplateRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> container <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>ViewContainerRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> injector <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>Injector<span class="token punctuation">)</span><span class="token punctuation">;</span>

  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> myInject<span class="token operator">!</span><span class="token punctuation">:</span> T<span class="token punctuation">;</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> myInjectDefault<span class="token operator">?</span><span class="token punctuation">:</span> ProviderTokenValue<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">;</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> myInjectHost<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> myInjectSelf<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> myInjectSkipSelf<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> myInjectOptional<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>

  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建上下文</span>
    <span class="token keyword">const</span> context<span class="token punctuation">:</span> MyInjectContext<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      myInject<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>myInject<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>myInjectDefault<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        host<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>myInjectHost<span class="token punctuation">,</span>
        self<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>myInjectSelf<span class="token punctuation">,</span>
        skipSelf<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>myInjectSkipSelf<span class="token punctuation">,</span>
        optional<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>myInjectOptional<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 渲染模板，并传入上下文</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>template<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 可选的模板类型守卫，帮助模板编译器确定模板上下文类型</span>
  <span class="token keyword">static</span> ngTemplateContextGuard<span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">ProviderToken</span><span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span>
    dir<span class="token punctuation">:</span> MyInjectDirective<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span>
    ctx<span class="token punctuation">:</span> unknown
  <span class="token punctuation">)</span><span class="token punctuation">:</span> ctx is MyInjectContext<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/** 用于提取 ProviderToken&lt;V> 中的泛型 V 的类型 */</span>
type ProviderTokenValue<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">=</span> T <span class="token keyword">extends</span> <span class="token class-name">ProviderToken</span><span class="token operator">&lt;</span>infer V<span class="token operator">></span> <span class="token operator">?</span> V <span class="token punctuation">:</span> never<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/** TemplateRef 上下文接口 */</span>
<span class="token keyword">interface</span> <span class="token class-name">MyInjectContext</span><span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">ProviderToken</span><span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token operator">></span><span class="token operator">></span> <span class="token punctuation">{</span>
  myInject<span class="token punctuation">:</span> ProviderTokenValue<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></div></code></pre>
<div class="dg-paragraph"><a target="_blank" href="https://stackblitz.com/edit/stackblitz-starters-3fwbf7?file=src%2Fmain.ts">查看在线示例</a>，Enjoy!</div>
<br>

<blockquote>
<p>💡 <strong>答案揭晓</strong></p>
<div class="dg-paragraph"><code>ngFor</code> 也<strong>可以</strong>把前缀缩短为 <code>ng</code> 来使用，写法如下：</div>
<pre class="language-html"><code class="language-html"><div><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ng</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>let hero; forOf heros; for<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></div></code></pre>
</blockquote>

        <h2 id="reference" class="docs-header-link">
          <span header-link="reference"></span>
          Reference
        </h2>
      <ul>
<li><a target="_blank" href="https://angular.io/guide/built-in-directives">https://angular.io/guide/built-in-directives</a></li>
<li><a target="_blank" href="https://angular.io/guide/structural-directives">https://angular.io/guide/structural-directives</a></li>
<li><a target="_blank" href="https://angular.io/guide/template-reference-variables#template-input-variable">https://angular.io/guide/template-reference-variables#template-input-variable</a></li>
</ul>
